---

- name: Trusted Host Settings
  blockinfile:
    state: present
    block: |
      $settings['trusted_host_patterns'] = array(
      {% for host in drupal_trusted_hosts %}
        '{{ host }}',
      {% endfor %}
      );

    path: "{{ drupal_trusted_hosts_file }}"
    marker: // {mark} ANSIBLE MANAGED TRUSTED HOST BLOCK

- name: Configuration overrides
  blockinfile:
    state: present
    block: |
      {% for config in drupal_config_override %}
      $config['{{ config.configname }}']['{{ config.key }}'] = {{ config.value }};
      {% endfor %}
    path: "{{ drupal_trusted_hosts_file }}"
    marker: // {mark} ANSIBLE MANAGED CONFIG BLOCK

- name: Uninstall core search module
  command: drush -y pm-uninstall search
  args:
    chdir: "{{ drupal_core_path }}"
  register: uninstall_search
  changed_when: "'successfully uninstalled' in uninstall_search.stdout"

- name: Test if theme is Carapace
  command: drush -y config-get system.theme default
  args:
    chdir: "{{ drupal_core_path }}"
  register: drupal_theme_carapace
  changed_when: false
  check_mode: no

- name: Set theme to carapace
  command: drush -y config-set system.theme default carapace
  args:
    chdir: "{{ drupal_core_path }}"
  when: "'carapace' not in drupal_theme_carapace.stdout"

- name: Set permissions on the public files directory
  file:
    recurse: yes
    state: directory
    path: "{{ drupal_public_filesystem }}"
    owner: "{{ drupal_public_filesystem_user }}"
    group: "{{ drupal_public_filesystem_user }}"
